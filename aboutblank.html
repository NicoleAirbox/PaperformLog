<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRN Request Form: Live Submission Log</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Datepicker CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <!-- Custom CSS -->
    <style>
        body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #c7c7c7; /* Add this line */
        }
        .container {
        width: 95%;
        margin: auto;
        }
        h1 {
        text-align: center;
        margin-bottom: 30px;
        }
        .date-range-container {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        label {
            margin-right: 5px;
        }
        input[type="text"] {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        select {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #searchButton {
            background-color: #5cb85c;
            color: white;
        }
        #resetButton {
            background-color: #e65252;
            color: white;
        }
        #downloadCsvButton {
            background-color: #4f89bc;
            color: white;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
        border: 1px solid #ccc; /* Changed border color */
        padding: 8px;
        text-align: left;
        }
        th {
        background-color: #f5f4f4; /* Changed header background */
        text-align: center;
        white-space: nowrap; /* Prevent text wrapping in headers */
        }
        tr:nth-child(even) {
        background-color: #f2f2f2; /* Changed even row background */
        }
        .highlight {
            background-color: lightgreen;
        }
        /* Adjust column widths */
        th[data-column="timestamp"], td:nth-child(1) { width: 150px; }
        th[data-column="Brand"], td:nth-child(2) { width: 100px; }
        th[data-column="Staff member"], td:nth-child(3) { width: 120px; }
        th[data-column="Supplier"], td:nth-child(4) { width: 100px; }
        th[data-column="Receiving warehouse"], td:nth-child(5) { width: 150px; }
        th[data-column="Shipment type"], td:nth-child(6) { width: 120px; }
        th[data-column="Haulier/Courier"], td:nth-child(7) { width: 120px; }
        th[data-column="Container type"], td:nth-child(8) { width: 100px; }
        th[data-column="Container unloading type"], td:nth-child(9) { width: 150px; }
        th[data-column="Tracking"], td:nth-child(10) { width: 100px; }
        th[data-column="Movement reference number (MRN)"], td:nth-child(11) { width: 200px; }
        th[data-column="MRN information"], td:nth-child(12) { width: 150px; }
        th[data-column="Domestic delivery"], td:nth-child(13) { width: 100px; }
        th[data-column="Date of shipment arrival"], td:nth-child(14) { width: 150px; }
        th[data-column="Date of product launch"], td:nth-child(15) { width: 150px; }
        th[data-column="Unit quantity"], td:nth-child(16) { width: 100px; }
        th[data-column="Carton quantity"], td:nth-child(17) { width: 100px; }
        th[data-column="Pallet quantity"], td:nth-child(18) { width: 100px; }
        th[data-column="Allocation type"], td:nth-child(19) { width: 120px; }
        th[data-column="Mixed shipment"], td:nth-child(20) { width: 100px; }
        th[data-column="ASN ID number(s)"], td:nth-child(21) { width: 150px; }
        th[data-column="Stock movement"], td:nth-child(22) { width: 120px; }
        th[data-column="Prepacks ASN file"], td:nth-child(23) { width: 150px; }
        th[data-column="Packing list name"], td:nth-child(24) { width: 150px; }
        th[data-column="Outer labels"], td:nth-child(25) { width: 150px; }
        th[data-column="Documents"], td:nth-child(26) { width: 150px; }
        th[data-column="System status"], td:nth-child(27) { width: 120px; }
        th[data-column="Stock status"], td:nth-child(28) { width: 120px; }
        th[data-column="Remedial work"], td:nth-child(29) { width: 120px; }
        th[data-column="Remedial work details"], td:nth-child(30) { width: 150px; }
        th[data-column="Remedial work files"], td:nth-child(31) { width: 150px; }
        th[data-column="Pre-order"], td:nth-child(32) { width: 100px; }
        th[data-column="Launch date of pre-order"], td:nth-child(33) { width: 150px; }
        th[data-column="Launch time of pre-order"], td:nth-child(34) { width: 150px; }
        th[data-column="Pre-order SKUs"], td:nth-child(35) { width: 150px; }
        th[data-column="Further comments"], td:nth-child(36) { width: 150px; }
    
        /* Center the search input */
        #searchInput {
            text-align: left; /* Center the text within the input */
        }
    
        /* Adjust the containing div for centering */
        div > div:nth-child(3) {
            text-align: left;
        }
    </style>
</head>
<body>

    <div class="container">
        <div style="text-align: center;">
            <img src="ABFnoback.png" alt="Your Logo" style="max-height: 200px; margin-bottom: 20px;">
        </div>
        <div style="text-align: center;">
            <img src="aboutblanknoback.png" alt="Second Logo" style="max-height: 50px; margin-bottom: 50px;">
        </div>
        <h1 style="text-align: center;">
            SRN Request Form: Live Submission Log
        </h1>
    </div>

    <!-- Search and Filter Section -->
    <div>
        <div style="display: flex;">
            <!-- Date Range Filters for "Submitted at" -->
            <div class="date-range-container" style="margin-right: 15px;">
                <label for="submittedAtFrom">Submitted at: </label>
                <input type="text" id="submittedAtFrom" class="datepicker" placeholder="start date" style="width: 190px;">
                <label for="submittedAtTo"> </label>
                <input type="text" id="submittedAtTo" class="datepicker" placeholder="finish date" style="width: 190px;">
            </div>
        
            <!-- Date Range Filters for "Date of Shipment Arrival" -->
            <div class="date-range-container">
                <label for="shipmentArrivalFrom">Date of shipment arrival: </label>
                <input type="text" id="shipmentArrivalFrom" class="datepicker" placeholder="start date" style="width: 190px;">
                <label for="shipmentArrivalTo"> </label>
                <input type="text" id="shipmentArrivalTo" class="datepicker" placeholder="finish date" style="width: 190px;">
            </div>
        </div>

        <!-- Add margin-bottom to create space -->
    <div style="width: 100%;">


            <!-- Input and button on the same line -->
            <div style="display: flex; justify-content: left; margin-bottom: 50px;">
                <input type="text" id="searchInput" placeholder="Search..." style="width: 500px; text-align: left;"> 
                <button id="searchButton" style="margin-left: 5px;">Go</button>
                <button id="resetButton" class="btn btn-secondary" style="margin-left: 5px;">Reset</button>
        </div>
    </div>

    <div style="display: flex; align-items: center;margin-bottom: 10px">
        <!-- CSV Download Button -->
        <button id="downloadCsvButton" class="btn btn-primary" style="margin-right: 5px; background-color: #4f89bc;">Download CSV</button>
        <a href="https://aboutblank.paperform.co/" class="btn btn-primary" style="margin-right: 5px; background-color: rgb(255, 226, 3); color: rgb(255, 255, 255); border-color: #ffd621; text-decoration: none; padding: 8px 12px;border: none;border-radius: 4px;cursor: pointer;">Submit a new form</a>
    </div>
    

    <div class="table-container">
        <table id="logTable" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th data-column="timestamp">Submitted at</th>
                    <th data-column="Brand">Brand</th>
                    <th data-column="Staff member">Staff member</th>
                    <th data-column="Supplier">Supplier</th>
                    <th data-column="Receiving warehouse">Receiving warehouse</th>
                    <th data-column="Shipment type">Shipment type</th>
                    <th data-column="Haulier/Courier">Haulier/Courier</th>
                    <th data-column="Container type">Container type</th>
                    <th data-column="Container unloading type">Container unloading type</th>
                    <th data-column="Tracking">Tracking</th>
                    <th data-column="Movement reference number (MRN)">Movement reference number (MRN)</th>
                    <th data-column="MRN information">MRN information</th>
                    <th data-column="Domestic delivery">Domestic delivery</th>
                    <th data-column="Date of shipment arrival">Date of shipment arrival</th>
                    <th data-column="Date of product launch">Date of product launch</th>
                    <th data-column="Unit quantity">Unit quantity</th>
                    <th data-column="Carton quantity">Carton quantity</th>
                    <th data-column="Pallet quantity">Pallet quantity</th>
                    <th data-column="Allocation type">Allocation type</th>
                    <th data-column="Mixed shipment">Mixed shipment</th>
                    <th data-column="ASN ID number(s)">ASN ID number(s)</th>
                    <th data-column="Stock movement">Stock movement</th>
                    <th data-column="Prepacks ASN file">Prepacks ASN file</th>
                    <th data-column="Packing list name">Packing list name</th>
                    <th data-column="Outer labels">Outer labels</th>
                    <th data-column="Documents">Documents</th>
                    <th data-column="System status">System status</th>
                    <th data-column="Stock status">Stock status</th>
                    <th data-column="Remedial work">Remedial work</th>
                    <th data-column="Remedial work details">Remedial work details</th>
                    <th data-column="Remedial work files">Remedial work files</th>
                    <th data-column="Pre-order">Pre-order</th>
                    <th data-column="Launch date of pre-order">Launch date of pre-order</th>
                    <th data-column="Launch time of pre-order">Launch time of pre-order</th>
                    <th data-column="Pre-order SKUs">Pre-order SKUs</th>
                    <th data-column="Further comments">Further comments</th>
                </tr>
            </thead>
            <tbody>
                <!-- New submissions will appear here -->
            </tbody>
        </table>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<!-- Datepicker JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<script>
    let allSubmissions = []; // Store all submissions
    let filteredSubmissions = []; // Store filtered submissions
    let currentSortColumn = 'timestamp'; // Default sort column
    let currentSortDirection = 'desc'; // Default sort direction (descending for "Submitted at")

    // Datepicker initialization
    $(document).ready(function() {
        $('.datepicker').datepicker({
            format: 'yyyy-mm-dd',
            autoclose: true
        });
    });
    async function fetchSubmissions() {
        try {
            const response = await fetch('aboutblank.json');
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const text = await response.text(); // Get the response as text
            let data = [];

            if (text) { // Check if the response is not empty
                try {
                    data = JSON.parse(text); // Try to parse it as JSON
                } catch (e) {
                    console.error("Error parsing JSON:", e);
                    return; // Exit if parsing fails
                }
            } else {
                console.log("aboutblank.json is empty.");
                return; // Exit if the file is empty
            }

            // Sort by "Submitted at" in descending order (most recent first)
            data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            allSubmissions = data; // Store all submissions
            filteredSubmissions = [...allSubmissions]; // Initially, filtered submissions are all submissions
            renderTable(filteredSubmissions);
        } catch (error) {
            console.error("Error fetching submissions:", error);
        }
    }

    function renderTable(data) {
        const table = document.getElementById("logTable").getElementsByTagName('tbody')[0];
        table.innerHTML = "";

        data.forEach(entry => {
            const newRow = table.insertRow();
            newRow.insertCell(0).innerHTML = entry["timestamp"] ? moment(entry["timestamp"]).format('YYYY-MM-DD HH:mm:ss') : "";
            newRow.insertCell(1).innerText = entry["Brand"] || "";
            newRow.insertCell(2).innerText = entry["Staff member"] || "";
            newRow.insertCell(3).innerText = entry["Supplier"] || "";
            newRow.insertCell(4).innerText = entry["Receiving warehouse"] || "";
            newRow.insertCell(5).innerText = entry["Shipment type"] || "";
            newRow.insertCell(6).innerText = entry["Haulier/Courier"] || "";
            newRow.insertCell(7).innerText = entry["Container type"] || "";
            newRow.insertCell(8).innerText = entry["Container unloading type"] || "";
            newRow.insertCell(9).innerText = entry["Tracking"] || "";
            newRow.insertCell(10).innerText = entry["Movement reference number (MRN)"] || "";
            newRow.insertCell(11).innerText = entry["MRN information"] || "";
            newRow.insertCell(12).innerText = entry["Domestic delivery"] || "";
            newRow.insertCell(13).innerText = entry["Date of shipment arrival"] || "";
            newRow.insertCell(14).innerText = entry["Date of product launch"] || "";
            newRow.insertCell(15).innerText = entry["Unit quantity"] || "";
            newRow.insertCell(16).innerText = entry["Carton quantity"] || "";
            newRow.insertCell(17).innerText = entry["Pallet quantity"] || "";
            newRow.insertCell(18).innerText = entry["Allocation type"] || "";
            newRow.insertCell(19).innerText = entry["Mixed shipment"] || "";
            newRow.insertCell(20).innerText = entry["ASN ID number(s)"] || "";
            newRow.insertCell(21).innerText = entry["Stock movement"] || "";
            newRow.insertCell(22).innerText = entry["Prepacks ASN file"] || "";
            newRow.insertCell(23).innerText = entry["Packing list name"] || "";
            newRow.insertCell(24).innerText = entry["Outer labels"] || "";

            // Create a download link for documents
            const documentsCell = newRow.insertCell(25);
            const documents = entry["Documents"];
            if (documents) {
                if (Array.isArray(documents)) {
                    documents.forEach(doc => {
                        const a = document.createElement('a');
                        a.href = doc;  // Corrected: Use the URL directly
                        a.textContent = doc.split('/').pop(); // Corrected: Extract filename from URL
                        a.download = doc.split('/').pop(); // Suggest a filename for download
                        documentsCell.appendChild(a);
                        documentsCell.appendChild(document.createElement('br')); // Add a line break for multiple documents
                    });
                } else {
                    const a = document.createElement('a');
                    a.href = documents; // Corrected: Use the URL directly
                    a.textContent = documents.split('/').pop(); // Corrected: Extract filename from URL
                    a.download = documents.split('/').pop(); // Suggest a filename for download
                    documentsCell.appendChild(a);
                }
            }

            newRow.insertCell(26).innerText = entry["System status"] || "";
            newRow.insertCell(27).innerText = entry["Stock status"] || "";
            newRow.insertCell(28).innerText = entry["Remedial work"] || "";
            newRow.insertCell(29).innerText = entry["Remedial work details"] || "";
            newRow.insertCell(30).innerText = entry["Remedial work files"] || "";
             // Add download links for additional file fields
            const remedialWorkFilesCell = newRow.insertCell(30);
            const remedialWorkFiles = entry["Remedial work files"];
            if (remedialWorkFiles) {
                if (Array.isArray(remedialWorkFiles)) {
                    remedialWorkFiles.forEach(file => {
                        const a = document.createElement('a');
                        a.href = file;  // Corrected: Use the URL directly
                        a.textContent = file.split('/').pop(); // Corrected: Extract filename from URL
                        a.download = file.split('/').pop(); // Suggest a filename for download
                        remedialWorkFilesCell.appendChild(a);
                        remedialWorkFilesCell.appendChild(document.createElement('br')); // Add a line break for multiple documents
                    });
                } else {
                    const a = document.createElement('a');
                    a.href = remedialWorkFiles; // Corrected: Use the URL directly
                    a.textContent = remedialWorkFiles.split('/').pop(); // Corrected: Extract filename from URL
                    a.download = remedialWorkFiles.split('/').pop(); // Suggest a filename for download
                    remedialWorkFilesCell.appendChild(a);
                }
            }
            newRow.insertCell(31).innerText = entry["Pre-order"] || "";
            newRow.insertCell(32).innerText = entry["Launch date of pre-order"] || "";
            newRow.insertCell(33).innerText = entry["Launch time of pre-order"] || "";
            newRow.insertCell(34).innerText = entry["Pre-order SKUs"] || "";
            newRow.insertCell(35).innerText = entry["Further comments"] || "";
        });
    }
    function highlightSearchResults(searchTerm) {
        const table = document.getElementById("logTable");
        const rows = table.getElementsByTagName("tr");

        for (let i = 1; i < rows.length; i++) { // Start from 1 to skip header row
            const cells = rows[i].getElementsByTagName("td");
            let rowHighlighted = false; // Flag to track if any cell in the row is highlighted

            for (let j = 0; j < cells.length; j++) {
                const cell = cells[j];
                const text = cell.innerText.toLowerCase();

                // Reset background color
                cell.classList.remove('highlight');

                if (searchTerm && text.includes(searchTerm.toLowerCase())) {
                    cell.classList.add('highlight');
                    rowHighlighted = true; // Set the flag if any cell is highlighted
                }
            }

            //If no cells in the row are highlighted, remove the highlight class from all cells
            if (!rowHighlighted) {
                for (let j = 0; j < cells.length; j++) {
                    cells[j].classList.remove('highlight');
                }
            }
        }
    }


    function filterTable() {
        const searchTerm = document.getElementById("searchInput").value.toLowerCase();

        filteredSubmissions = allSubmissions.filter(entry => {
            for (const key in entry) {
                if (entry.hasOwnProperty(key) && entry[key]) {
                    const cellValue = entry[key].toString().toLowerCase();
                    if (cellValue.includes(searchTerm)) {
                        return true; // If the search term is found in any column, return true
                    }
                }
            }
            return false; // If the search term is not found in any column, return false
        });


        filteredSubmissions = filterByDateRange(filteredSubmissions);

        renderTable(filteredSubmissions);
        highlightSearchResults(searchTerm);
    }

    function filterByDateRange(submissions) {
        const submittedAtFrom = $('#submittedAtFrom').datepicker('getDate');
        const submittedAtTo = $('#submittedAtTo').datepicker('getDate');
        const shipmentArrivalFrom = $('#shipmentArrivalFrom').datepicker('getDate');
        const shipmentArrivalTo = $('#shipmentArrivalTo').datepicker('getDate');

        let filtered = [...submissions];

        if (submittedAtFrom) {
            filtered = filtered.filter(entry => {
                const timestamp = entry.timestamp ? new Date(entry.timestamp) : null;
                return timestamp && timestamp >= submittedAtFrom;
            });
        }

        if (submittedAtTo) {
            filtered = filtered.filter(entry => {
                const timestamp = entry.timestamp ? new Date(entry.timestamp) : null;
                return timestamp && timestamp <= submittedAtTo;
            });
        }

         if (shipmentArrivalFrom) {
            filtered = filtered.filter(entry => {
                const arrivalDate = entry["Date of shipment arrival"] ? new Date(entry["Date of shipment arrival"]) : null;
                return arrivalDate && arrivalDate >= shipmentArrivalFrom;
            });
        }

        if (shipmentArrivalTo) {
            filtered = filtered.filter(entry => {
                const arrivalDate = entry["Date of shipment arrival"] ? new Date(entry["Date of shipment arrival"]) : null;
                return arrivalDate && arrivalDate <= shipmentArrivalTo;
            });
        }

        return filtered;
    }


    function sortTable(column) {
        if (column === currentSortColumn) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortColumn = column;
            currentSortDirection = 'asc';
        }

        const sortedData = [...filteredSubmissions].sort((a, b) => {
            const valueA = a[column] || '';
            const valueB = b[column] || '';

            if (valueA < valueB) {
                return currentSortDirection === 'asc' ? -1 : 1;
            }
            if (valueA > valueB) {
                return currentSortDirection === 'asc' ? 1 : -1;
            }
            return 0;
        });

        renderTable(sortedData);
    }
    function downloadCSV() {
        const csvRows = [];
        const headers = Array.from(document.querySelectorAll('#logTable th'))
            .map(th => th.innerText);
        csvRows.push(headers.join(','));

        const tableRows = document.querySelectorAll('#logTable tbody tr');
        tableRows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('td'))
                .map(td => {
                    let text = td.innerText;
                     // Check if the cell contains a link
                    const link = td.querySelector('a');
                    if (link) {
                        text = link.href; // Use the link if it exists
                    }
                    return '"' + text.replace(/"/g, '""') + '"';
                });
            csvRows.push(cells.join(','));
        });

        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'submission_log.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function resetFilters() {
        // Clear date pickers
        $('#submittedAtFrom').datepicker('setDate', null);
        $('#submittedAtTo').datepicker('setDate', null);
        $('#shipmentArrivalFrom').datepicker('setDate', null);
        $('#shipmentArrivalTo').datepicker('setDate', null);

        // Clear search input and column selection
        document.getElementById("searchInput").value = "";

        // Reset filtered submissions to all submissions
        filteredSubmissions = [...allSubmissions];

        // Re-render the table
        renderTable(filteredSubmissions);

        // Remove highlights
        const table = document.getElementById("logTable");
        const cells = table.getElementsByTagName("td");
        for (let i = 0; i < cells.length; i++) {
            cells[i].classList.remove('highlight');
        }
    }

    // Attach event listeners after the functions are defined
    document.getElementById("searchButton").addEventListener("click", filterTable);
    document.getElementById("searchInput").addEventListener("keyup", function(event) {
        // Trigger the button element with a click on the "Enter" key
        if (event.key === "Enter") {
            filterTable();
        }
    });

    // Event listener for column sorting
    document.querySelectorAll('#logTable th').forEach(th => {
        th.addEventListener('click', () => {
            const column = th.dataset.column;
            sortTable(column);
        });
    });

    document.getElementById("downloadCsvButton").addEventListener("click", downloadCSV);
    document.getElementById("resetButton").addEventListener("click", resetFilters);


    // Initial data fetch
    fetchSubmissions();
</script>

</body>
</html>